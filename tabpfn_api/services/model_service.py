import logging
from typing import List, Dict, Any

from sqlalchemy.ext.asyncio import AsyncSession

from tabpfn_api.models.user import User
from tabpfn_api.models.model import ModelMetadata
from tabpfn_api.tabpfn_interface.client import fit_model, TabPFNInterfaceError
from tabpfn_api.core.security import decrypt_token, InvalidToken

log = logging.getLogger(__name__)


class ModelServiceError(Exception):
    """Custom exception for model service layer errors."""
    pass


async def train_new_model(
    db: AsyncSession,
    current_user: User,
    features: List[List[Any]],
    target: List[Any],
    feature_names: List[str] | None = None,
    config: Dict[str, Any] | None = None
) -> str:
    """Trains a new TabPFN model, stores metadata, and returns the internal model ID.

    Args:
        db: The async database session.
        current_user: The authenticated User object (contains user_id and encrypted token).
        features: List of lists representing feature data.
        target: List representing target data.
        feature_names: Optional list of feature names.
        config: Optional dictionary of configuration for TabPFN's fit method.

    Returns:
        The internally generated UUID (as string) for the trained model.

    Raises:
        ModelServiceError: If decryption fails, TabPFN fitting fails, or DB operations fail.
    """
    config = config or {} # Ensure config is a dict
    log.info(f"User ID {current_user.id} initiating model training.")

    # 1. Decrypt the user's TabPFN token
    try:
        decrypted_tabpfn_token = decrypt_token(current_user.encrypted_tabpfn_token)
        log.debug(f"Successfully decrypted TabPFN token for user ID {current_user.id}.")
    except InvalidToken:
        log.error(f"Failed to decrypt TabPFN token for user ID {current_user.id}. Possible key mismatch or data corruption.")
        # This indicates a server configuration issue or data integrity problem.
        raise ModelServiceError("Internal error: Could not decrypt stored credentials.")
    except Exception as e:
        log.exception(f"Unexpected error decrypting token for user {current_user.id}")
        raise ModelServiceError(f"Internal error during credential decryption: {e}")

    # 2. Call the TabPFN interface to fit the model
    try:
        tabpfn_train_set_uid = fit_model(
            tabpfn_token=decrypted_tabpfn_token,
            features=features,
            target=target,
            config=config
        )
        log.info(f"TabPFN fitting complete for user ID {current_user.id}. train_set_uid: {tabpfn_train_set_uid}")
    except TabPFNInterfaceError as e:
        log.warning(f"TabPFN interface error during fitting for user ID {current_user.id}: {e}")
        # Pass the interface error message upwards, potentially map to HTTP errors later
        raise ModelServiceError(f"Failed to train model: {e}") from e
    except Exception as e:
        log.exception(f"Unexpected error during model fitting process for user {current_user.id}")
        raise ModelServiceError(f"An unexpected internal error occurred during model training: {e}") from e

    # 3. Prepare and save metadata to the database
    try:
        # Calculate basic metadata
        sample_count = len(features)
        feature_count = len(features[0]) if sample_count > 0 else 0

        # Create the ModelMetadata object (internal_model_id is generated by default)
        db_model_metadata = ModelMetadata(
            tabpfn_train_set_uid=tabpfn_train_set_uid,
            user_id=current_user.id,
            feature_count=feature_count,
            sample_count=sample_count,
            feature_names=feature_names, # Store provided feature names
            tabpfn_config=config # Store the config used
        )

        db.add(db_model_metadata)
        await db.commit()
        await db.refresh(db_model_metadata)

        internal_model_id = str(db_model_metadata.internal_model_id) # Convert UUID to string for return
        log.info(f"Successfully saved ModelMetadata for user ID {current_user.id}. Internal model ID: {internal_model_id}")

        return internal_model_id

    except Exception as e:
        log.exception(f"Failed to save ModelMetadata to database for user ID {current_user.id} after successful TabPFN fit (train_set_uid: {tabpfn_train_set_uid}). Rolling back.")
        await db.rollback()
        # This is problematic: the model was trained in TabPFN, but we couldn't record it.
        # Consider adding cleanup logic or marking it as orphaned if possible.
        raise ModelServiceError("Failed to save model metadata after training.") from e 